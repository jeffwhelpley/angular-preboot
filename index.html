<html>
<body>
    <form>
        <input type="text" name="one" (keyup)="blah()"><br/>
        <input type="text" name="two" on-keyup="blah()"><br/>
        <input type="text" name="three"><br/>
        <input type="text" name="four" class="preboot" preboot-events="keyup"><br/>
        <button (click)="doit()">Click here</button>
        <br/><br/>
        <a href="" onclick="return log()">Log events to console</a>
        <br/><br/>
        <a href="" onclick="angularPreBoot.cleanup(); return false;">Do cleanup</a>
    </form>
    <script>
        (function () {

            // this is where we will store all the preboot events
            var preboot = window.angularPreBoot = { events: [] };

            // maintain the list of event listeners so we can remove them later
            var eventListeners = [];

            /**
             * Attach function to preboot that can be used to cleanup all resources.
             * This includes event handlers and the events themselves.
             */
            preboot.cleanup = function () {
                var listener, node;

                // first cleanup the event listeners
                for (var i = 0; i < eventListeners.length; i++) {
                    listener = eventListeners[i];
                    node = listener.node;
                    node.removeEventListener(listener.name, listener.handler);
                }

                // now remove the events
                preboot.events = [];
            };

            /**
             * For a given node, add an event listener based on the given attribute. The attribute
             * must match the Angular pattern for event handlers (i.e. either (event)='blah()' or
             * on-event='blah'
             *
             * @param node An element in the DOM
             * @param name The name of the event
             */
            function addListener(node, name) {

                // this is what will be called when the event occurs
                function handler(event) {

                    // if we are having angular handle events, we don't want to do the default
                    event.preventDefault();

                    // push event and other relevant info onto the preboot events
                    preboot.events.push({
                        node:       node,
                        event:      event,
                        name:       name,
                        time:       (new Date()).getTime()
                    })
                }

                // add listener which will record all events in global preboot object
                node.addEventListener(name, handler);

                // add handler to list so it can be removed later
                eventListeners.push({ node: node, name: name, handler: handler });
            }

            //************************** OPTION 1 - WALK THE DOM ****************************

            /**
             * This is from Crockford to walk the DOM:
             *  http://www.javascriptcookbook.com/article/Traversing-DOM-subtrees-with-a-recursive-walk-the-DOM-function/
             *
             * @param node The current node (to do entire document, pass in document.body)
             * @param func Function called for each node in the tree
             */
            function walkDOM(node, func) {
                func(node);
                node = node.firstChild;
                while (node) {
                    walkDOM(node,func);
                    node = node.nextSibling;
                }
            }

//            // regular expression for finding event
//            var eventPattern = /^(on\-.*)|(\(.*\))$/;
//
//            // with each DOM node, we check the attributes for event listeners
//            walkDOM(document.body, function (node) {
//                var attrs = node.attributes;
//                var attr, name;
//
//                if (attrs) {
//                    for (var i = 0; i < attrs.length; i++) {
//                        attr = attrs[i];
//                        name = attr.name;
//
//                        // if attribute name doesn't match Angular event handlers, don't do anything
//                        if (eventPattern.test(name)) {
//
//                            // extract event name from the () or on- (TODO: replace this w regex)
//                            name = name.charAt(0) === '(' ?
//                                    name.substring(1, name.length - 1) :    // remove parenthesis
//                                    name.substring(3);                      // remove on-
//
//                            addListener(node, name);
//                        }
//                    }
//                }
//            });


            //*********************** OPTION 2 - USE PREBOOT CLASS MARKERS *********************

            /**
             * This will find all elements that have Angular events through a class placed
             * by the server side rendering called 'preboot'. We will use the prebootEvents
             * attribute on these elements to register events
             */
            function findAndAttachPreBootHandlers() {
                var elems = document.getElementsByClassName('preboot');

                if (!elems) {
                    return;
                }

                var i, j, elem, events;
                for (i = 0; i < elems.length; i++) {
                    elem = elems[i];
                    if (elem.hasAttribute('preboot-events')) {
                        events = elem.getAttribute('preboot-events').split(',');
                        for (j = 0; j < events.length; j++) {
                            addListener(elem, events[i]);
                        }
                    }
                }
            }

            // as soon as script loads, start finding preboot elements and attaching handlers
            findAndAttachPreBootHandlers();

        })();

        // function to test that we recorded all events
        function log() {
            console.log(angularPreBoot.events);
            return false;
        }

    </script>
</body>
</html>